<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="ExDoc v0.24.2">
    <meta name="project" content="Astarte v1.1.0-dev">

    <title>Advanced operations â€” Astarte v1.1.0-dev</title>
    <link rel="stylesheet" href="dist/elixir-a172fe91e725dcb259e2.css" />

    <script src="dist/sidebar_items-a32df562ac.js"></script>

      <script src="../common_vars.js"></script>

    <script async src="dist/app-f27ff079945e43879c46.js"></script>


  </head>
  <body data-type="extras">
    <script>

      try {
        if (localStorage.getItem('night-mode') === 'true') {
          document.body.classList.add('night-mode');
        }
      } catch (error) { }
    </script>

<div class="main">

<button class="sidebar-button sidebar-toggle">
  <span class="icon-menu" title="Collapse/expand sidebar"></span>
</button>

<section class="sidebar">
  <form class="sidebar-search" action="search.html">
    <button type="submit" class="search-button" aria-label="Submit Search">
      <span class="icon-search" aria-hidden="true" title="Submit search"></span>
    </button>
    <button type="button" tabindex="-1" class="search-close-button" aria-label="Cancel Search">
      <span class="icon-cross" aria-hidden="true" title="Cancel search"></span>
    </button>
    <label class="search-label">
      <input name="q" type="text" class="search-input" placeholder="Search..." aria-label="Input your search terms" autocomplete="off" />
    </label>
  </form>

  <div class="autocomplete">
    <div class="autocomplete-results">
    </div>
  </div>

  <div class="sidebar-header">
    <div class="sidebar-projectDetails">
      <a href="http://astarte-platform.org" class="sidebar-projectName">
Astarte
      </a>
      <strong class="sidebar-projectVersion">
        v1.1.0-dev
      </strong>
    </div>

      <a href="http://astarte-platform.org">
        <img src="assets/logo.png" alt="Astarte" class="sidebar-projectImage">
      </a>

  </div>

  <ul class="sidebar-listNav">
    <li><a id="extras-list-link" href="#full-list">Pages</a></li>


  </ul>
  <div class="gradient"></div>
  <ul id="full-list" class="sidebar-fullList"></ul>
</section>

<section class="content">
  <div class="content-outer">
    <div id="content" class="content-inner">

<h1>Advanced operations</h1><p>This section provides guidance on some delicate operations that must be performed manually as they
could potentially result in data loss or other types of irrecoverable damage.</p><p><em>Always be careful while performing these operations!</em></p><p>Advanced operations are described in the following sections:</p><ul><li><a href="#manual-deletion-of-interfaces">Manual deletion of interfaces</a></li><li><a href="#manual-deletion-of-a-device">Manual deletion of a device</a></li><li><a href="#backup-your-astarte-resources">How to backup your Astarte resources</a></li><li><a href="#restore-your-backed-up-astarte-instance">How to restore your backed up Astarte instance</a></li><li><a href="#handling-astarte-when-uninstalling-the-operator">Handling Astarte when uninstalling the
Operator</a></li></ul><h2 id="manual-deletion-of-interfaces" class="section-heading">
  <a href="#manual-deletion-of-interfaces" class="hover-link"><span class="icon-link" aria-hidden="true"></span></a>
  Manual deletion of interfaces
</h2>
<p>Right now, Astarte only allows deleting draft interfaces, i.e. interfaces with major version <code class="inline">0</code> and
not used by any device.</p><p>If you want to delete an interface that has already published data, you must proceed manually with
the steps described below. This guide assumes the aim of the operation is deleting the
<code class="inline">org.astarte-platform.genericsensors.Values</code> interface in the <code class="inline">test</code> realm.</p><p>The guide requires that <a href="https://cassandra.apache.org/doc/latest/tools/cqlsh.html"><code class="inline">cqlsh</code></a> is
connected to the Cassandra/ScyllaDB instance that your Astarte instance is using.</p><h3 id="switch-to-the-target-keyspace" class="section-heading">
  <a href="#switch-to-the-target-keyspace" class="hover-link"><span class="icon-link" aria-hidden="true"></span></a>
  Switch to the target keyspace
</h3>
<p>The keyspace has the same name of the realm, in this case it is <code class="inline">test</code>:</p><pre><code class="makeup elixir"><span class="n">cqlsh</span><span class="o">&gt;</span><span class="w"> </span><span class="kn">use</span><span class="w"> </span><span class="n">test</span><span class="p">;</span></code></pre><h3 id="find-out-the-interface-id" class="section-heading">
  <a href="#find-out-the-interface-id" class="hover-link"><span class="icon-link" aria-hidden="true"></span></a>
  Find out the interface id
</h3>
<pre><code class="makeup elixir"><span class="n">cqlsh</span><span class="ss">:test</span><span class="o">&gt;</span><span class="w"> </span><span class="nc">SELECT</span><span class="w"> </span><span class="n">interface_id</span><span class="w"> </span><span class="nc">FROM</span><span class="w"> </span><span class="n">interfaces</span><span class="w">
  </span><span class="nc">WHERE</span><span class="w"> </span><span class="n">name</span><span class="o">=</span><span class="sc">&#39;org.astarte-platform.genericsensors.Values&#39;</span><span class="w">
  </span><span class="nc">AND</span><span class="w"> </span><span class="n">major_version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span></code></pre><p><code class="inline">cqlsh</code> will reply with the interface id:</p><pre><code class="makeup elixir"><span class="w"> </span><span class="n">interface_id</span><span class="w">
</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="w">
 </span><span class="n">c238b244</span><span class="o">-</span><span class="n">b90f</span><span class="o">-</span><span class="mi">4</span><span class="n">c6d</span><span class="o">-</span><span class="n">f276</span><span class="o">-</span><span class="mi">25768</span><span class="n">bf6abac</span></code></pre><h3 id="delete-the-interface" class="section-heading">
  <a href="#delete-the-interface" class="hover-link"><span class="icon-link" aria-hidden="true"></span></a>
  Delete the interface
</h3>
<p><em>WARNING: This is a destructive step that will erase the correlation between the Interface name and
internal ID. Before proceeding, ensure you saved the interface ID, or you will end up with dangling
data. Further steps in this guide will require the interface ID.</em></p><p>To delete the interface,</p><pre><code class="makeup elixir"><span class="n">cqlsh</span><span class="ss">:test</span><span class="o">&gt;</span><span class="w"> </span><span class="nc">DELETE</span><span class="w"> </span><span class="nc">FROM</span><span class="w"> </span><span class="n">interfaces</span><span class="w">
  </span><span class="nc">WHERE</span><span class="w"> </span><span class="n">name</span><span class="o">=</span><span class="sc">&#39;org.astarte-platform.genericsensors.Values&#39;</span><span class="w">
  </span><span class="nc">AND</span><span class="w"> </span><span class="n">major_version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span></code></pre><p><em>Keep in mind that after this step, all existing devices that attempt to publish on this interface
will be disconnected as soon as they try to do so.</em></p><h3 id="delete-interface-data" class="section-heading">
  <a href="#delete-interface-data" class="hover-link"><span class="icon-link" aria-hidden="true"></span></a>
  Delete interface data
</h3>
<p>The interface data is stored in a different place depending on the interface type (<code class="inline">datastream</code> or
<code class="inline">properties</code>) and aggregation.</p><ul><li>Individual datastream interfaces store their data in the <code class="inline">individual_datastreams</code> table.</li><li>Individual properties interfaces store their data in the <code class="inline">individual_properties</code> table.</li><li>Object datastream interfaces store their data in a dedicated table which is created starting from
the interface (e.g. an interface called <code class="inline">com.test.Sensors</code> with major version <code class="inline">1</code> creates a
<code class="inline">com_test_sensors_v1</code> table in the realm keyspace).</li></ul><p>To delete data from object datastreams, a simple <code class="inline">DROP</code> of the table where the data is stored is
needed.</p><p>Deleting data from individual interfaces requires more steps. In this example the interface is an
individual datastream, but the procedure for individual properties is the same, but concerns the
<code class="inline">individual_properties</code> table instead.</p><p>To delete the interface data, first all relevant primary keys must be found:</p><pre><code class="makeup elixir"><span class="n">cqlsh</span><span class="ss">:test</span><span class="o">&gt;</span><span class="w"> </span><span class="nc">SELECT</span><span class="w"> </span><span class="nc">DISTINCT</span><span class="w"> </span><span class="n">device_id</span><span class="p">,</span><span class="w"> </span><span class="n">interface_id</span><span class="p">,</span><span class="w"> </span><span class="n">endpoint_id</span><span class="p">,</span><span class="w"> </span><span class="n">path</span><span class="w"> </span><span class="nc">FROM</span><span class="w"> </span><span class="n">individual_datastreams</span><span class="w">
  </span><span class="nc">WHERE</span><span class="w"> </span><span class="n">interface_id</span><span class="o">=</span><span class="n">c238b244</span><span class="o">-</span><span class="n">b90f</span><span class="o">-</span><span class="mi">4</span><span class="n">c6d</span><span class="o">-</span><span class="n">f276</span><span class="o">-</span><span class="mi">25768</span><span class="n">bf6abac</span><span class="w"> </span><span class="nc">ALLOW</span><span class="w"> </span><span class="nc">FILTERING</span><span class="p">;</span></code></pre><p>This will return a set of primary keys of data belonging to that interface:</p><pre><code class="makeup elixir"><span class="w"> </span><span class="n">device_id</span><span class="w">                            </span><span class="o">|</span><span class="w"> </span><span class="n">interface_id</span><span class="w">                         </span><span class="o">|</span><span class="w"> </span><span class="n">endpoint_id</span><span class="w">                          </span><span class="o">|</span><span class="w"> </span><span class="n">path</span><span class="w">
</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">|</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">|</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">|</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">-</span><span class="w">
 </span><span class="mi">41</span><span class="n">c1c072</span><span class="o">-</span><span class="n">d416</span><span class="o">-</span><span class="mi">4686</span><span class="o">-</span><span class="n">ba23</span><span class="o">-</span><span class="mi">673</span><span class="n">fe4ad926f</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">c238b244</span><span class="o">-</span><span class="n">b90f</span><span class="o">-</span><span class="mi">4</span><span class="n">c6d</span><span class="o">-</span><span class="n">f276</span><span class="o">-</span><span class="mi">25768</span><span class="n">bf6abac</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">33751412</span><span class="o">-</span><span class="mi">3</span><span class="n">e77</span><span class="o">-</span><span class="n">ad1f</span><span class="o">-</span><span class="n">ad57</span><span class="o">-</span><span class="mi">280</span><span class="n">cc9fad581</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="o">/</span><span class="n">test</span><span class="o">/</span><span class="n">value</span><span class="w">
 </span><span class="mi">81</span><span class="n">c60277</span><span class="o">-</span><span class="mi">4645</span><span class="o">-</span><span class="mi">441</span><span class="n">f</span><span class="o">-</span><span class="n">a49b</span><span class="o">-</span><span class="mi">66</span><span class="n">a71ce54b83</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">c238b244</span><span class="o">-</span><span class="n">b90f</span><span class="o">-</span><span class="mi">4</span><span class="n">c6d</span><span class="o">-</span><span class="n">f276</span><span class="o">-</span><span class="mi">25768</span><span class="n">bf6abac</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">33751412</span><span class="o">-</span><span class="mi">3</span><span class="n">e77</span><span class="o">-</span><span class="n">ad1f</span><span class="o">-</span><span class="n">ad57</span><span class="o">-</span><span class="mi">280</span><span class="n">cc9fad581</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="o">/</span><span class="n">foo</span><span class="o">/</span><span class="n">value</span><span class="w">
 </span><span class="n">...</span></code></pre><p>After that, all data belonging to those primary keys must be deleted:</p><pre><code class="makeup elixir"><span class="n">cqlsh</span><span class="ss">:test</span><span class="o">&gt;</span><span class="w"> </span><span class="nc">DELETE</span><span class="w"> </span><span class="nc">FROM</span><span class="w"> </span><span class="n">individual_datastreams</span><span class="w">
  </span><span class="nc">WHERE</span><span class="w"> </span><span class="n">device_id</span><span class="o">=</span><span class="mi">41</span><span class="n">c1c072</span><span class="o">-</span><span class="n">d416</span><span class="o">-</span><span class="mi">4686</span><span class="o">-</span><span class="n">ba23</span><span class="o">-</span><span class="mi">673</span><span class="n">fe4ad926f</span><span class="w">
  </span><span class="nc">AND</span><span class="w"> </span><span class="n">interface_id</span><span class="o">=</span><span class="n">c238b244</span><span class="o">-</span><span class="n">b90f</span><span class="o">-</span><span class="mi">4</span><span class="n">c6d</span><span class="o">-</span><span class="n">f276</span><span class="o">-</span><span class="mi">25768</span><span class="n">bf6abac</span><span class="w">
  </span><span class="nc">AND</span><span class="w"> </span><span class="n">endpoint_id</span><span class="o">=</span><span class="mi">33751412</span><span class="o">-</span><span class="mi">3</span><span class="n">e77</span><span class="o">-</span><span class="n">ad1f</span><span class="o">-</span><span class="n">ad57</span><span class="o">-</span><span class="mi">280</span><span class="n">cc9fad581</span><span class="w">
  </span><span class="nc">AND</span><span class="w"> </span><span class="n">path</span><span class="o">=</span><span class="sc">&#39;/test/value&#39;</span><span class="p">;</span><span class="w">

</span><span class="n">cqlsh</span><span class="ss">:test</span><span class="o">&gt;</span><span class="w"> </span><span class="nc">DELETE</span><span class="w"> </span><span class="nc">FROM</span><span class="w"> </span><span class="n">individual_datastreams</span><span class="w">
  </span><span class="nc">WHERE</span><span class="w"> </span><span class="n">device_id</span><span class="o">=</span><span class="mi">81</span><span class="n">c60277</span><span class="o">-</span><span class="mi">4645</span><span class="o">-</span><span class="mi">441</span><span class="n">f</span><span class="o">-</span><span class="n">a49b</span><span class="o">-</span><span class="mi">66</span><span class="n">a71ce54b83</span><span class="w">
  </span><span class="nc">AND</span><span class="w"> </span><span class="n">interface_id</span><span class="o">=</span><span class="n">c238b244</span><span class="o">-</span><span class="n">b90f</span><span class="o">-</span><span class="mi">4</span><span class="n">c6d</span><span class="o">-</span><span class="n">f276</span><span class="o">-</span><span class="mi">25768</span><span class="n">bf6abac</span><span class="w">
  </span><span class="nc">AND</span><span class="w"> </span><span class="n">endpoint_id</span><span class="o">=</span><span class="mi">33751412</span><span class="o">-</span><span class="mi">3</span><span class="n">e77</span><span class="o">-</span><span class="n">ad1f</span><span class="o">-</span><span class="n">ad57</span><span class="o">-</span><span class="mi">280</span><span class="n">cc9fad581</span><span class="w">
  </span><span class="nc">AND</span><span class="w"> </span><span class="n">path</span><span class="o">=</span><span class="sc">&#39;/foo/value&#39;</span><span class="p">;</span><span class="w">
</span><span class="n">...</span></code></pre><h3 id="devices-by-interface-cleanup" class="section-heading">
  <a href="#devices-by-interface-cleanup" class="hover-link"><span class="icon-link" aria-hidden="true"></span></a>
  <code class="inline">devices-by-interface</code> cleanup
</h3>
<p>If this guide is being used so as to remove a draft interface (i.e. with major version <code class="inline">0</code>) that
cannot be deleted since it has data on it, an additional step is required for a complete cleanup.</p><p>The information about which devices are using draft interfaces is kept in the <code class="inline">kv_store</code> table. You
can inspect the groups with:</p><pre><code class="makeup elixir"><span class="n">cqlsh</span><span class="ss">:test</span><span class="o">&gt;</span><span class="w"> </span><span class="nc">SELECT</span><span class="w"> </span><span class="n">group</span><span class="w"> </span><span class="nc">FROM</span><span class="w"> </span><span class="n">kv_store</span><span class="p">;</span></code></pre><p>The group that has to be deleted may be easily identified by inspecting the returned <code class="inline">group</code>s, since
it is the one with its name derived from the interface name. For example, if the purpose of the
operation is removing all data from the <code class="inline">org.astarte-platform.genericevents.DeviceEvents v0.1</code>
interface, the corresponding <code class="inline">group</code> in <code class="inline">kv_store</code> will be
<code class="inline">devices-by-interface-org.astarte-platform.genericevents.DeviceEvents-v0</code>.</p><p>As the target group is identified, just remove all its entries with:</p><pre><code class="makeup elixir"><span class="n">cqlsh</span><span class="ss">:test</span><span class="o">&gt;</span><span class="w"> </span><span class="nc">DELETE</span><span class="w"> </span><span class="nc">FROM</span><span class="w"> </span><span class="n">kv_store</span><span class="w"> </span><span class="nc">WHERE</span><span class="w"> </span><span class="n">group</span><span class="o">=</span><span class="sc">&#39;devices-by-interface-org.astarte-platform.genericevents.DeviceEvents-v0&#39;</span><span class="p">;</span></code></pre><h3 id="conclusion" class="section-heading">
  <a href="#conclusion" class="hover-link"><span class="icon-link" aria-hidden="true"></span></a>
  Conclusion
</h3>
<p>After performing all the steps above, the interface will be completely removed from Astarte. You can
then proceed to install a new interface with the same name and major version without any conflict.
<em>Remember to remove the interface also on the device side, otherwise devices will keep getting
disconnected if they try to publish on the deleted interface.</em></p><hr class="thin"/><h2 id="manual-deletion-of-a-device" class="section-heading">
  <a href="#manual-deletion-of-a-device" class="hover-link"><span class="icon-link" aria-hidden="true"></span></a>
  Manual deletion of a device
</h2>
<p>Currently, the Astarte API allows for the unregistration and the inhibition of a specific device. If
you want to entirely delete a device from your realm along with its data, a manual procedure is
required.</p><p>This section assumes:</p><ul><li>that <code class="inline">cqlsh</code> is connected to the Cassandra/ScyllaDB instance that your Astarte is using;</li><li>that <code class="inline">astartectl</code> is installed on your machine.</li></ul><p><strong><em>Please keep in mind that this is a destructive procedure. Before moving on, ensure you saved your
device ID or you might end up with dangling data and possibly a damaged Astarte deployment.</em></strong></p><h3 id="retrieve-the-device-uuid" class="section-heading">
  <a href="#retrieve-the-device-uuid" class="hover-link"><span class="icon-link" aria-hidden="true"></span></a>
  Retrieve the device uuid
</h3>
<p>To interact with the device and its data, the device uuid must be retrieved. Assuming that the
id of the device to be deleted is <code class="inline">k3oPTXaGGGGGGGGGGGGGGG</code>, its uuid can be obtained with the
following:</p><pre><code class="bash">$ astartectl utils device-id to-uuid k3oPTXaGGGGGGGGGGGGGGG
937a0f4d-7686-1861-8618-618618618618</code></pre><p>Please, make sure not to lose the device uuid as it will be employed in all the following steps of
this section.</p><h3 id="switch-to-the-target-keyspace-1" class="section-heading">
  <a href="#switch-to-the-target-keyspace-1" class="hover-link"><span class="icon-link" aria-hidden="true"></span></a>
  Switch to the target keyspace
</h3>
<p>The keyspace takes its name from the realm, in this case it is <code class="inline">test</code>.</p><pre><code class="makeup elixir"><span class="n">cqlsh</span><span class="o">&gt;</span><span class="w"> </span><span class="kn">use</span><span class="w"> </span><span class="n">test</span><span class="p">;</span></code></pre><h3 id="delete-device-data-on-a-specific-interface" class="section-heading">
  <a href="#delete-device-data-on-a-specific-interface" class="hover-link"><span class="icon-link" aria-hidden="true"></span></a>
  Delete device data on a specific interface
</h3>
<p>Depending on the interface type and aggregation, data published by the device is stored into
different tables:</p><ul><li>data published over an individual datastream interface are available within the
<code class="inline">individual_datastreams</code> table;</li><li>data published over an individual property interface are available within the
<code class="inline">individual_properties</code> table;</li><li>data published over an object datastream interfaces are stored in a dedicated table named after
the interface name: e.g. an interface called <code class="inline">com.test.Sensors</code> with major version 1 creates a
<code class="inline">com_test_sensors_v1</code> table in the realm keyspace.</li></ul><h4>Delete device data from an <code class="inline">individual_datastreams</code> interface</h4><p>The first step consists in finding all the relevant primary keys for the device. To do so, simply
run:</p><pre><code class="makeup elixir"><span class="n">cqlsh</span><span class="ss">:test</span><span class="o">&gt;</span><span class="w"> </span><span class="nc">SELECT</span><span class="w"> </span><span class="nc">DISTINCT</span><span class="w"> </span><span class="n">device_id</span><span class="p">,</span><span class="w"> </span><span class="n">interface_id</span><span class="p">,</span><span class="w"> </span><span class="n">endpoint_id</span><span class="p">,</span><span class="w"> </span><span class="n">path</span><span class="w"> </span><span class="nc">FROM</span><span class="w"> </span><span class="n">individual_datastreams</span><span class="w">
  </span><span class="nc">WHERE</span><span class="w"> </span><span class="n">device_id</span><span class="o">=</span><span class="mi">937</span><span class="n">a0f4d</span><span class="o">-</span><span class="mi">7686</span><span class="o">-</span><span class="mi">1861</span><span class="o">-</span><span class="mi">8618</span><span class="o">-</span><span class="mi">618618618618</span><span class="w"> </span><span class="nc">ALLOW</span><span class="w"> </span><span class="nc">FILTERING</span><span class="p">;</span></code></pre><p>The output will show a set of primary keys of data belonging to your device:</p><pre><code class="makeup elixir"><span class="w"> </span><span class="n">device_id</span><span class="w">                            </span><span class="o">|</span><span class="w"> </span><span class="n">interface_id</span><span class="w">                         </span><span class="o">|</span><span class="w"> </span><span class="n">endpoint_id</span><span class="w">                          </span><span class="o">|</span><span class="w"> </span><span class="n">path</span><span class="w">
</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">|</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">|</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">|</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">-</span><span class="w">
 </span><span class="mi">937</span><span class="n">a0f4d</span><span class="o">-</span><span class="mi">7686</span><span class="o">-</span><span class="mi">1861</span><span class="o">-</span><span class="mi">8618</span><span class="o">-</span><span class="mi">618618618618</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">c238b244</span><span class="o">-</span><span class="n">b90f</span><span class="o">-</span><span class="mi">4</span><span class="n">c6d</span><span class="o">-</span><span class="n">f276</span><span class="o">-</span><span class="mi">25768</span><span class="n">bf6abac</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">33751412</span><span class="o">-</span><span class="mi">3</span><span class="n">e77</span><span class="o">-</span><span class="n">ad1f</span><span class="o">-</span><span class="n">ad57</span><span class="o">-</span><span class="mi">280</span><span class="n">cc9fad581</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="o">/</span><span class="n">test</span><span class="o">/</span><span class="n">value</span><span class="w">
 </span><span class="mi">937</span><span class="n">a0f4d</span><span class="o">-</span><span class="mi">7686</span><span class="o">-</span><span class="mi">1861</span><span class="o">-</span><span class="mi">8618</span><span class="o">-</span><span class="mi">618618618618</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">1</span><span class="n">e6fb841</span><span class="o">-</span><span class="mi">9</span><span class="n">ee3</span><span class="o">-</span><span class="mi">0</span><span class="n">e60</span><span class="o">-</span><span class="mi">72</span><span class="n">ed</span><span class="o">-</span><span class="mi">1</span><span class="n">f55b334b832</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">33751412</span><span class="o">-</span><span class="mi">3</span><span class="n">e77</span><span class="o">-</span><span class="n">ad1f</span><span class="o">-</span><span class="n">ad57</span><span class="o">-</span><span class="mi">280</span><span class="n">cc9fad581</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="o">/</span><span class="n">foo</span><span class="o">/</span><span class="n">value</span><span class="w">
 </span><span class="n">...</span></code></pre><p>It is now time to perform the actual data deletion: to do so, repeat the following instruction
iterating over every combination of primary keys as obtained from the output of the previous
command:</p><pre><code class="makeup elixir"><span class="n">cqlsh</span><span class="ss">:test</span><span class="o">&gt;</span><span class="w"> </span><span class="nc">DELETE</span><span class="w"> </span><span class="nc">FROM</span><span class="w"> </span><span class="n">individual_datastreams</span><span class="w">
  </span><span class="nc">WHERE</span><span class="w"> </span><span class="n">device_id</span><span class="o">=</span><span class="mi">937</span><span class="n">a0f4d</span><span class="o">-</span><span class="mi">7686</span><span class="o">-</span><span class="mi">1861</span><span class="o">-</span><span class="mi">8618</span><span class="o">-</span><span class="mi">618618618618</span><span class="w">
  </span><span class="nc">AND</span><span class="w"> </span><span class="n">interface_id</span><span class="o">=</span><span class="n">c238b244</span><span class="o">-</span><span class="n">b90f</span><span class="o">-</span><span class="mi">4</span><span class="n">c6d</span><span class="o">-</span><span class="n">f276</span><span class="o">-</span><span class="mi">25768</span><span class="n">bf6abac</span><span class="w">
  </span><span class="nc">AND</span><span class="w"> </span><span class="n">endpoint_id</span><span class="o">=</span><span class="mi">33751412</span><span class="o">-</span><span class="mi">3</span><span class="n">e77</span><span class="o">-</span><span class="n">ad1f</span><span class="o">-</span><span class="n">ad57</span><span class="o">-</span><span class="mi">280</span><span class="n">cc9fad581</span><span class="w">
  </span><span class="nc">AND</span><span class="w"> </span><span class="n">path</span><span class="o">=</span><span class="sc">&#39;/test/value&#39;</span><span class="p">;</span></code></pre><h4>Delete device data from an <code class="inline">individual_properties</code> interface</h4><p>The first step consists in retrieving the primary keys for the device. Just run:</p><pre><code class="makeup elixir"><span class="n">cqlsh</span><span class="ss">:test</span><span class="o">&gt;</span><span class="w"> </span><span class="nc">SELECT</span><span class="w"> </span><span class="nc">DISTINCT</span><span class="w"> </span><span class="n">device_id</span><span class="p">,</span><span class="w"> </span><span class="n">interface_id</span><span class="w"> </span><span class="nc">FROM</span><span class="w"> </span><span class="n">individual_properties</span><span class="w">
  </span><span class="nc">WHERE</span><span class="w"> </span><span class="n">device_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">937</span><span class="n">a0f4d</span><span class="o">-</span><span class="mi">7686</span><span class="o">-</span><span class="mi">1861</span><span class="o">-</span><span class="mi">8618</span><span class="o">-</span><span class="mi">618618618618</span><span class="w"> </span><span class="nc">ALLOW</span><span class="w"> </span><span class="nc">FILTERING</span><span class="p">;</span></code></pre><p>The output will be similar to the following one:</p><pre><code class="makeup elixir"><span class="w"> </span><span class="n">device_id</span><span class="w">                            </span><span class="o">|</span><span class="w"> </span><span class="n">interface_id</span><span class="w">
</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">+</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="w">
 </span><span class="mi">937</span><span class="n">a0f4d</span><span class="o">-</span><span class="mi">7686</span><span class="o">-</span><span class="mi">1861</span><span class="o">-</span><span class="mi">8618</span><span class="o">-</span><span class="mi">618618618618</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">c238b244</span><span class="o">-</span><span class="n">b90f</span><span class="o">-</span><span class="mi">4</span><span class="n">c6d</span><span class="o">-</span><span class="n">f276</span><span class="o">-</span><span class="mi">25768</span><span class="n">bf6abac</span><span class="w">
 </span><span class="mi">937</span><span class="n">a0f4d</span><span class="o">-</span><span class="mi">7686</span><span class="o">-</span><span class="mi">1861</span><span class="o">-</span><span class="mi">8618</span><span class="o">-</span><span class="mi">618618618618</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">8</span><span class="n">ed086db</span><span class="o">-</span><span class="mi">0</span><span class="n">bcc</span><span class="o">-</span><span class="mi">5</span><span class="n">a9f</span><span class="o">-</span><span class="mi">2</span><span class="n">fc2</span><span class="o">-</span><span class="n">ddf49c35e87d</span><span class="w">
 </span><span class="mi">937</span><span class="n">a0f4d</span><span class="o">-</span><span class="mi">7686</span><span class="o">-</span><span class="mi">1861</span><span class="o">-</span><span class="mi">8618</span><span class="o">-</span><span class="mi">618618618618</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">c61879ce</span><span class="o">-</span><span class="n">c60c</span><span class="o">-</span><span class="n">adaf</span><span class="o">-</span><span class="n">c6b4</span><span class="o">-</span><span class="n">d04b1e1b14c4</span></code></pre><p>To perform the actual data deletion, run the following query for each pair of <code class="inline">device_id</code> and
<code class="inline">interface_id</code> obtained from the previous query:</p><pre><code class="makeup elixir"><span class="n">cqlsh</span><span class="ss">:test</span><span class="o">&gt;</span><span class="w"> </span><span class="nc">DELETE</span><span class="w"> </span><span class="nc">FROM</span><span class="w"> </span><span class="n">individual_properties</span><span class="w">
  </span><span class="nc">WHERE</span><span class="w"> </span><span class="n">device_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">937</span><span class="n">a0f4d</span><span class="o">-</span><span class="mi">7686</span><span class="o">-</span><span class="mi">1861</span><span class="o">-</span><span class="mi">8618</span><span class="o">-</span><span class="mi">618618618618</span><span class="w">
  </span><span class="nc">AND</span><span class="w"> </span><span class="n">interface_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">c238b244</span><span class="o">-</span><span class="n">b90f</span><span class="o">-</span><span class="mi">4</span><span class="n">c6d</span><span class="o">-</span><span class="n">f276</span><span class="o">-</span><span class="mi">25768</span><span class="n">bf6abac</span><span class="p">;</span></code></pre><h4>Delete device data for object datastreams</h4><p>The first step consists in retrieving the primary keys for the device. For this particular example
the sample interface named <code class="inline">com.test.Sensors</code> with major version <code class="inline">v1</code> is employed. Please note that
the upcoming steps must be repeated for each object datastream interface installed in your realm.</p><pre><code class="makeup elixir"><span class="n">cqlsh</span><span class="ss">:test</span><span class="o">&gt;</span><span class="w"> </span><span class="nc">SELECT</span><span class="w"> </span><span class="nc">DISTINCT</span><span class="w"> </span><span class="n">device_id</span><span class="p">,</span><span class="w"> </span><span class="n">path</span><span class="w"> </span><span class="nc">FROM</span><span class="w"> </span><span class="n">com_test_sensors_v1</span><span class="w"> </span><span class="nc">WHERE</span><span class="w">
  </span><span class="n">device_id</span><span class="o">=</span><span class="mi">937</span><span class="n">a0f4d</span><span class="o">-</span><span class="mi">7686</span><span class="o">-</span><span class="mi">1861</span><span class="o">-</span><span class="mi">8618</span><span class="o">-</span><span class="mi">618618618618</span><span class="w"> </span><span class="nc">ALLOW</span><span class="w"> </span><span class="nc">FILTERING</span><span class="p">;</span></code></pre><p>The output will show something like:</p><pre><code class="makeup elixir"><span class="w"> </span><span class="n">device_id</span><span class="w">                            </span><span class="o">|</span><span class="w"> </span><span class="n">path</span><span class="w">
</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">+</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="w">
 </span><span class="mi">937</span><span class="n">a0f4d</span><span class="o">-</span><span class="mi">7686</span><span class="o">-</span><span class="mi">1861</span><span class="o">-</span><span class="mi">8618</span><span class="o">-</span><span class="mi">618618618618</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="o">/</span><span class="n">foo</span><span class="w">
 </span><span class="n">...</span></code></pre><p>It is now time to perform the actual data deletion:</p><pre><code class="makeup elixir"><span class="n">cqlsh</span><span class="ss">:test</span><span class="o">&gt;</span><span class="w"> </span><span class="nc">DELETE</span><span class="w"> </span><span class="nc">FROM</span><span class="w"> </span><span class="n">com_test_sensors_v1</span><span class="w">
  </span><span class="nc">WHERE</span><span class="w"> </span><span class="n">device_id</span><span class="o">=</span><span class="mi">937</span><span class="n">a0f4d</span><span class="o">-</span><span class="mi">7686</span><span class="o">-</span><span class="mi">1861</span><span class="o">-</span><span class="mi">8618</span><span class="o">-</span><span class="mi">618618618618</span><span class="w">
  </span><span class="nc">AND</span><span class="w"> </span><span class="n">path</span><span class="o">=</span><span class="sc">&#39;/foo&#39;</span><span class="p">;</span></code></pre><h3 id="delete-device-aliases" class="section-heading">
  <a href="#delete-device-aliases" class="hover-link"><span class="icon-link" aria-hidden="true"></span></a>
  Delete device aliases
</h3>
<p>If your device has one or more aliases you will find them in the <code class="inline">names</code> table.</p><p>First, you have to find the primary key for the device:</p><pre><code class="makeup elixir"><span class="n">cqlsh</span><span class="ss">:test</span><span class="o">&gt;</span><span class="w"> </span><span class="nc">SELECT</span><span class="w"> </span><span class="n">object_name</span><span class="w"> </span><span class="nc">FROM</span><span class="w"> </span><span class="n">names</span><span class="w">
  </span><span class="nc">WHERE</span><span class="w"> </span><span class="n">object_uuid</span><span class="o">=</span><span class="mi">937</span><span class="n">a0f4d</span><span class="o">-</span><span class="mi">7686</span><span class="o">-</span><span class="mi">1861</span><span class="o">-</span><span class="mi">8618</span><span class="o">-</span><span class="mi">618618618618</span><span class="w"> </span><span class="nc">ALLOW</span><span class="w"> </span><span class="nc">FILTERING</span><span class="p">;</span></code></pre><p>If your device has any aliases, the output will show</p><pre><code class="makeup elixir"><span class="w"> </span><span class="n">object_name</span><span class="w">
</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="w">
 </span><span class="n">my</span><span class="o">-</span><span class="n">device</span><span class="o">-</span><span class="kn">alias</span><span class="w">
 </span><span class="n">...</span></code></pre><p>Thus, you can delete the alias simply executing:</p><pre><code class="makeup elixir"><span class="n">cqlsh</span><span class="ss">:test</span><span class="o">&gt;</span><span class="w"> </span><span class="nc">DELETE</span><span class="w"> </span><span class="nc">FROM</span><span class="w"> </span><span class="n">names</span><span class="w"> </span><span class="nc">WHERE</span><span class="w"> </span><span class="n">object_name</span><span class="o">=</span><span class="sc">&#39;my-device-alias&#39;</span><span class="p">;</span></code></pre><h3 id="delete-the-device-from-groups" class="section-heading">
  <a href="#delete-the-device-from-groups" class="hover-link"><span class="icon-link" aria-hidden="true"></span></a>
  Delete the device from groups
</h3>
<p>To delete the device from a device group let's find the needed keys:</p><pre><code class="makeup elixir"><span class="nc">SELECT</span><span class="w"> </span><span class="n">group_name</span><span class="p">,</span><span class="w"> </span><span class="n">insertion_uuid</span><span class="p">,</span><span class="w"> </span><span class="n">device_id</span><span class="w">
  </span><span class="nc">FROM</span><span class="w"> </span><span class="n">grouped_devices</span><span class="w">
  </span><span class="nc">WHERE</span><span class="w"> </span><span class="n">device_id</span><span class="o">=</span><span class="mi">937</span><span class="n">a0f4d</span><span class="o">-</span><span class="mi">7686</span><span class="o">-</span><span class="mi">1861</span><span class="o">-</span><span class="mi">8618</span><span class="o">-</span><span class="mi">618618618618</span><span class="w">
  </span><span class="nc">ALLOW</span><span class="w"> </span><span class="nc">FILTERING</span><span class="p">;</span></code></pre><p>If the device is contained in one or more groups, the output will be:</p><pre><code class="makeup elixir"><span class="w"> </span><span class="n">group_name</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">insertion_uuid</span><span class="w">                       </span><span class="o">|</span><span class="w"> </span><span class="n">device_id</span><span class="w">
</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">+</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">+</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="w">
   </span><span class="n">my</span><span class="o">-</span><span class="n">group</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">c1a0dade</span><span class="o">-</span><span class="mi">43</span><span class="n">bc</span><span class="o">-</span><span class="mi">11</span><span class="n">ec</span><span class="o">-</span><span class="mi">95</span><span class="n">be</span><span class="o">-</span><span class="mi">41</span><span class="n">f7663270b3</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">937</span><span class="n">a0f4d</span><span class="o">-</span><span class="mi">7686</span><span class="o">-</span><span class="mi">1861</span><span class="o">-</span><span class="mi">8618</span><span class="o">-</span><span class="mi">618618618618</span><span class="w">
   </span><span class="n">...</span></code></pre><p>The actual deletion can be performed with:</p><pre><code class="makeup elixir"><span class="n">cqlsh</span><span class="ss">:test</span><span class="o">&gt;</span><span class="w"> </span><span class="nc">DELETE</span><span class="w"> </span><span class="nc">FROM</span><span class="w"> </span><span class="n">grouped_devices</span><span class="w">
  </span><span class="nc">WHERE</span><span class="w"> </span><span class="n">group_name</span><span class="o">=</span><span class="sc">&#39;my-group&#39;</span><span class="w">
  </span><span class="nc">AND</span><span class="w"> </span><span class="n">insertion_uuid</span><span class="o">=</span><span class="n">c1a0dade</span><span class="o">-</span><span class="mi">43</span><span class="n">bc</span><span class="o">-</span><span class="mi">11</span><span class="n">ec</span><span class="o">-</span><span class="mi">95</span><span class="n">be</span><span class="o">-</span><span class="mi">41</span><span class="n">f7663270b3</span><span class="w">
  </span><span class="nc">AND</span><span class="w"> </span><span class="n">device_id</span><span class="o">=</span><span class="mi">937</span><span class="n">a0f4d</span><span class="o">-</span><span class="mi">7686</span><span class="o">-</span><span class="mi">1861</span><span class="o">-</span><span class="mi">8618</span><span class="o">-</span><span class="mi">618618618618</span><span class="p">;</span></code></pre><h3 id="delete-entries-from-kv_store" class="section-heading">
  <a href="#delete-entries-from-kv_store" class="hover-link"><span class="icon-link" aria-hidden="true"></span></a>
  Delete entries from <code class="inline">kv_store</code>
</h3>
<p>If your device is publishing over one or more interfaces with version <code class="inline">v0</code>, you will need to handle
also the <code class="inline">kv_store</code> table.</p><p>Retrieve all the entries that must be handled:</p><pre><code class="makeup elixir"><span class="n">cqlsh</span><span class="ss">:test</span><span class="o">&gt;</span><span class="w"> </span><span class="nc">SELECT</span><span class="w"> </span><span class="n">group</span><span class="p">,</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="nc">FROM</span><span class="w"> </span><span class="n">kv_store</span><span class="w"> </span><span class="nc">WHERE</span><span class="w"> </span><span class="n">key</span><span class="o">=</span><span class="sc">&#39;k3oPTXaGGGGGGGGGGGGGGG&#39;</span><span class="w"> </span><span class="nc">ALLOW</span><span class="w"> </span><span class="nc">FILTERING</span><span class="p">;</span></code></pre><p>The output of the query will show something similar to</p><pre><code class="makeup elixir"><span class="w"> </span><span class="n">group</span><span class="w">                                                   </span><span class="o">|</span><span class="w"> </span><span class="n">key</span><span class="w">
</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">-</span><span class="o">+</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="w">
             </span><span class="n">devices</span><span class="o">-</span><span class="n">by</span><span class="o">-</span><span class="n">interface</span><span class="o">-</span><span class="n">com</span><span class="o">.</span><span class="n">test</span><span class="o">.</span><span class="nc">Sensor</span><span class="o">-</span><span class="n">v0</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">k3oPTXaGGGGGGGGGGGGGGG</span><span class="w">
   </span><span class="n">devices</span><span class="o">-</span><span class="k">with</span><span class="o">-</span><span class="n">data</span><span class="o">-</span><span class="n">on</span><span class="o">-</span><span class="n">interface</span><span class="o">-</span><span class="n">com</span><span class="o">.</span><span class="n">test</span><span class="o">.</span><span class="nc">Sensor</span><span class="o">-</span><span class="n">v0</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">k3oPTXaGGGGGGGGGGGGGGG</span><span class="w">
   </span><span class="n">...</span></code></pre><p>To remove the entries, simply execute the following queries to remove the proper rows from the
table. Please, make sure to remove all the entries referencing your device ID.</p><pre><code class="makeup elixir"><span class="n">cqlsh</span><span class="ss">:test</span><span class="o">&gt;</span><span class="w"> </span><span class="nc">DELETE</span><span class="w"> </span><span class="nc">FROM</span><span class="w"> </span><span class="n">kv_store</span><span class="w">
  </span><span class="nc">WHERE</span><span class="w"> </span><span class="n">group</span><span class="o">=</span><span class="sc">&#39;devices-by-interface-com.test.Sensor-v0&#39;</span><span class="w">
  </span><span class="nc">AND</span><span class="w"> </span><span class="n">key</span><span class="o">=</span><span class="sc">&#39;k3oPTXaGGGGGGGGGGGGGGG&#39;</span><span class="p">;</span><span class="w">

</span><span class="n">cqlsh</span><span class="ss">:test</span><span class="o">&gt;</span><span class="w"> </span><span class="nc">DELETE</span><span class="w"> </span><span class="nc">FROM</span><span class="w"> </span><span class="n">kv_store</span><span class="w">
  </span><span class="nc">WHERE</span><span class="w"> </span><span class="n">group</span><span class="o">=</span><span class="sc">&#39;devices-with-data-on-interface-com.test.Sensor-v0&#39;</span><span class="w">
  </span><span class="nc">AND</span><span class="w"> </span><span class="n">key</span><span class="o">=</span><span class="sc">&#39;k3oPTXaGGGGGGGGGGGGGGG&#39;</span><span class="p">;</span></code></pre><h3 id="eventually-delete-your-device" class="section-heading">
  <a href="#eventually-delete-your-device" class="hover-link"><span class="icon-link" aria-hidden="true"></span></a>
  Eventually delete your device
</h3>
<p>Deleting your device from the devices table is as simple as</p><pre><code class="makeup elixir"><span class="n">cqlsh</span><span class="ss">:test</span><span class="o">&gt;</span><span class="w"> </span><span class="nc">DELETE</span><span class="w"> </span><span class="nc">FROM</span><span class="w"> </span><span class="n">devices</span><span class="w"> </span><span class="nc">WHERE</span><span class="w"> </span><span class="n">device_id</span><span class="o">=</span><span class="mi">937</span><span class="n">a0f4d</span><span class="o">-</span><span class="mi">7686</span><span class="o">-</span><span class="mi">1861</span><span class="o">-</span><span class="mi">8618</span><span class="o">-</span><span class="mi">618618618618</span><span class="p">;</span></code></pre><h3 id="conclusions" class="section-heading">
  <a href="#conclusions" class="hover-link"><span class="icon-link" aria-hidden="true"></span></a>
  Conclusions
</h3>
<p>If you managed to remove all the device-related entries as described in the previous sections, then
your device and its data have been properly deleted from Astarte.</p><p>Before trying to reconnect your device you <strong>must</strong> make sure that the SSL certificate and all
the credentials onboard your device are deleted. This is crucial for ensuring that new data
published by the device can be properly ingested and processed by Astarte.</p><hr class="thin"/><h2 id="backup-your-astarte-resources" class="section-heading">
  <a href="#backup-your-astarte-resources" class="hover-link"><span class="icon-link" aria-hidden="true"></span></a>
  Backup your Astarte resources
</h2>
<p>Backing up your Astarte resources is crucial in all those cases when your Astarte instance has to be
restored after an unforeseen event (e.g. accidental deletion of resources, deletion of the
Operator - as it will be discussed later on - etc.).</p><p>A full recovery of your Astarte instance along with all the persisted data is possible <strong>if and only
if</strong> your Cassandra/Scylla instance is deployed independently from Astarte, i.e. it must be deployed
outside of the Astarte CR scope. Provided that this condition is met, all the data persist in the
database even when Astarte is deleted from your cluster.</p><p>To restore your Astarte instance all you have to do is saving the following resources:</p><ul><li>Astarte CR;</li><li>AstarteVoyagerIngress CR (if deployed);</li><li>AstarteDefaultIngress CR (if deployed);</li><li>CA certificate and key;</li></ul><p>and, assuming that the name of your Astarte is <code class="inline">astarte</code> and that it is deployed within the
<code class="inline">astarte</code> namespace, it can be done simply executing the following commands:</p><pre><code class="bash">kubectl get astarte -n astarte -o yaml &gt; astarte-backup.yaml
kubectl get avi -n astarte -o yaml &gt; avi-backup.yaml
kubectl get adi -n astarte -o yaml &gt; adi-backup.yaml
kubectl get secret astarte-devices-ca -n astarte -o yaml &gt; astarte-devices-ca-backup.yaml</code></pre><hr class="thin"/><h2 id="restore-your-backed-up-astarte-instance" class="section-heading">
  <a href="#restore-your-backed-up-astarte-instance" class="hover-link"><span class="icon-link" aria-hidden="true"></span></a>
  Restore your backed up Astarte instance
</h2>
<p>To restore your Astarte instance simply apply the resources you saved as described
<a href="#backup-your-astarte-resources">here</a>. Please, be aware that the order of the operations matters.</p><pre><code class="bash">kubectl apply -f astarte-devices-ca-backup.yaml
kubectl apply -f astarte-backup.yaml</code></pre><p>And when your Astarte resource is ready, to restore your AstarteVoyagerIngress:</p><pre><code class="bash">kubectl apply -f avi-backup.yaml</code></pre><p>while to restore your AstarteDefaultIngress resource:</p><pre><code class="bash">kubectl apply -f adi-backup.yaml</code></pre><p>At the end of this step, your cluster is restored. Please, notice that the external IP of the
ingress services might have changed. Take action to ensure that the changes of the IP are reflected
anywhere appropriate in your deployment.</p><hr class="thin"/><h2 id="handling-astarte-when-uninstalling-the-operator" class="section-heading">
  <a href="#handling-astarte-when-uninstalling-the-operator" class="hover-link"><span class="icon-link" aria-hidden="true"></span></a>
  Handling Astarte when uninstalling the Operator
</h2>
<p>Installing the Astarte Operator is as simple as installing its Helm chart. Even if the
install and upgrade procedures are very simple and straightforward, the design choices behind the
development of the Operator must be taken into account to avoid undesired effects while handling the
Operator's lifecycle.</p><p>The installation of the Operator's Helm chart is responsible for the creation of RBACs, the creation
of the Operator's deployment and the installation of Astarte CRDs. The fact that all the CRDs
installed with the Helm chart are templated has some important consequences: if on one hand this
characteristic ensures great flexibility in configuring your Astarte instance, on the other hand it
entails the possibility of deleting the CRDs by simply uninstalling the Operator.</p><p>The following sections will highlight what happens under the hood while uninstalling the Operator
and show the suggested path to restore your Astarte instance after the removal of the Operator.</p><p>Please, read carefully the following sections before taking any actions on your cluster and be aware
that improper operations may have catastrophic effects on your Astarte instance.</p><h3 id="what-happens-when-uninstalling-the-operator" class="section-heading">
  <a href="#what-happens-when-uninstalling-the-operator" class="hover-link"><span class="icon-link" aria-hidden="true"></span></a>
  What happens when uninstalling the Operator
</h3>
<p>The Operator's installation procedure marks all the Astarte CRDs as owned by the Operator itself.
Therefore, when the Operator is uninstalled all the CRDs are seen as orphaned and the Kubernetes
controller automatically sets them as ready to be deleted. Thus, when the Operator is uninstalled
you end up with the following situation:</p><ul><li>Flow and AstarteVoyagerIngress CRDs are deleted, along with the custom resources depending on
said CRDs;</li><li>Astarte CRD is marked for deletion, but its removal is postponed until the moment in which the
Astarte finalizer is executed.</li></ul><h3 id="backup-your-resources" class="section-heading">
  <a href="#backup-your-resources" class="hover-link"><span class="icon-link" aria-hidden="true"></span></a>
  Backup your resources
</h3>
<p>Even if removing the Operator can potentially destroy your Astarte instance, there is a way to
restore it avoiding any data loss. Please, refer to <a href="#backup-your-astarte-resources">this dedicated
section</a> to understand how to backup your resources.</p><h3 id="uninstall-the-operator" class="section-heading">
  <a href="#uninstall-the-operator" class="hover-link"><span class="icon-link" aria-hidden="true"></span></a>
  Uninstall the Operator
</h3>
<p>Once the backup of your resources is completed you can <code class="inline">helm uninstall</code> the Operator as explained
<a href="030-installation_kubernetes.html#uninstalling-the-operator">here</a>.</p><p>Once the Operator is deleted your Astarte instance will be marked for deletion. You can see it
simply checking the <code class="inline">Deletion timestamp</code> field in the output of:</p><pre><code class="bash">kubectl describe astarte -n astarte</code></pre><h3 id="reinstalling-the-operator" class="section-heading">
  <a href="#reinstalling-the-operator" class="hover-link"><span class="icon-link" aria-hidden="true"></span></a>
  Reinstalling the Operator
</h3>
<p>Reinstalling the Operator is crucial to have a correct management of your Astarte instance. The
installation is handled simply with an <code class="inline">helm install</code> command as explained
<a href="030-installation_kubernetes.html#installation">here</a>.</p><p>When the first reconciliation loop is executed, the Operator becomes aware that the Astarte resource
is marked for deletion, so it executes the Astarte finalizer and eventually destroys Astarte's CRD
and its resources.</p><p>Even if it might look like the status of the cluster is compromised, a simple command reestablishes
order:</p><pre><code class="bash">helm upgrade --install astarte-operator astarte/astarte-operator -n kube-system</code></pre><p>This command simply upgrades the Operator and, as a result, installs the missing CRDs. Now it is
time to restore the Astarte resources.</p><h3 id="apply-backed-up-resources" class="section-heading">
  <a href="#apply-backed-up-resources" class="hover-link"><span class="icon-link" aria-hidden="true"></span></a>
  Apply backed up resources
</h3>
<p>To restore your Astarte instance simply follow the instructions outlined
<a href="#restore-your-backed-up-astarte-instance">here</a>.</p><h3 id="conclusion-1" class="section-heading">
  <a href="#conclusion-1" class="hover-link"><span class="icon-link" aria-hidden="true"></span></a>
  Conclusion
</h3>
<p>The procedure presented in the current section allows to handle the deletion of the Operator from
your cluster without losing any of Astarte's data. Currently some manual intervention is required to
ensure that the integrity of your instance is not compromised by the uninstall procedure.</p>
<div class="bottom-actions">
  <div class="bottom-actions-item">

      <a href="090-monitoring.html" class="bottom-actions-button" rel="prev">
        <span class="subheader">
          â† Previous Page
        </span>
        <span class="title">
Monitoring
        </span>
      </a>

  </div>
  <div class="bottom-actions-item">

      <a href="000-upgrade_index.html" class="bottom-actions-button" rel="next">
        <span class="subheader">
          Next Page â†’
        </span>
        <span class="title">
Upgrade Procedures
        </span>
      </a>

  </div>
</div>

      <footer class="footer">
        <p>
          <span class="line">
            Built using
            <a href="https://github.com/elixir-lang/ex_doc" title="ExDoc" target="_blank" rel="help noopener">ExDoc</a> (v0.24.2) for the
            <a href="https://elixir-lang.org" title="Elixir" target="_blank">Elixir programming language</a>.
          </span>
          <span class="line">
            Designed by
            <a href="https://twitter.com/dignifiedquire" target="_blank" rel="noopener" title="@dignifiedquire">Friedel Ziegelmayer</a>.
          </span>
        </p>
        <p>

          <button class="line footer-button display-shortcuts-help">
            Display keyboard shortcuts
          </button>
          <button class="line footer-button night-mode-toggle">
            Toggle night mode
          </button>
          <button class="line footer-button display-quick-switch">
            Go to a HexDocs package
          </button>
          <button class="line footer-button tooltips-toggle">
            <span class="tooltips-option-disable">Disable tooltips</span>
            <span class="tooltips-option-enable">Enable tooltips</span>
          </button>
        </p>
      </footer>
    </div>
  </div>
</section>
</div>


  </body>
</html>
