<!---
  Copyright 2024 SECO Mind Srl
  SPDX-License-Identifier: Apache-2.0
-->
<!-- HTML header for doxygen 1.12.0-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.12.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Astarte device API for Zephyr: Astarte-MQTT-client-architecture</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="doxygen-awesome-darkmode-toc.js"></script>
<script type="text/javascript">
  DoxygenAwesomeInteractiveToc.init()
</script>
<script type="text/javascript" src="doxygen-awesome-paragraph-link.js"></script>
<script type="text/javascript">
    DoxygenAwesomeParagraphLink.init()
</script>
<script type="text/javascript" src="doxygen-awesome-fragment-copy-button.js"></script>
<script type="text/javascript">
  DoxygenAwesomeFragmentCopyButton.init()
</script>
<script type="text/javascript" src="doxygen-awesome-darkmode-toggle.js"></script>
<script type="text/javascript">
  DoxygenAwesomeDarkModeToggle.init()
</script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only-darkmode-toggle.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-custom.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">Astarte device API for Zephyr<span id="projectnumber">&#160;0.9.0</span>
   </div>
   <div id="projectbrief">Astarte device SDK for Zephyr RTOS</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.12.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(0); });
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search',true);
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('md__2home_2runner_2work_2astarte-device-sdk-zephyr_2astarte-device-sdk-zephyr_2astarte-device-sddef73e401b80b2170021b78ad2e458cc.html',''); initResizable(true); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Astarte-MQTT-client-architecture</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="autotoc_md22"></a>
Astarte MQTT client architecture</h1>
<p>Astarte MQTT client is a soft wrapper around the MQTT client library from Zephyr. It extends the functionality of the standard MQTT client.</p>
<h2><a class="anchor" id="autotoc_md23"></a>
Automatic reconnection</h2>
<p>The Astarte MQTT client implements an automatic reconnection policy in cases where connectivity with the MQTT broker is lost. An exponential backoff is used to limit reconnection attempts. The backoff time will start from the user configurable polling timeout and end at the minimum between the user configurable polling timeout and twice the keep alive time for the MQTT connection.</p>
<div class="fragment"><div class="line">%% This is a mermaid graph. Your can render it using the live editor at: https://mermaid.live</div>
<div class="line">flowchart TD</div>
<div class="line">    DISCONNECTED --&gt; |Connection request| CONNECTING</div>
<div class="line">    CONNECTING --&gt; |CONNACK reception| CONNECTED</div>
<div class="line">    CONNECTING --&gt; |Disconnection request| DISCONNECTING</div>
<div class="line">    CONNECTING --&gt; |Disconnection event/ poll failure / connection timeout elapsed| CONNECTION_ERROR</div>
<div class="line">    CONNECTED --&gt; |Disconnection request| DISCONNECTING</div>
<div class="line">    CONNECTED --&gt; |Disconnection event / poll failure| CONNECTION_ERROR</div>
<div class="line">    DISCONNECTING --&gt; |Disconnection event| DISCONNECTED</div>
<div class="line">    CONNECTION_ERROR --&gt; |Connection request / backoff period finished| CONNECTING</div>
<div class="line">    CONNECTION_ERROR --&gt; |Disconnection request| DISCONNECTED</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md24"></a>
Subscription retry procedure</h2>
<p>The Astarte MQTT client implements a retry mechanism to ensure subscription messages are properly retransmitted.</p>
<div class="fragment"><div class="line">%% This is a mermaid graph. Your can render it using the live editor at: https://mermaid.live</div>
<div class="line">flowchart TD</div>
<div class="line">    subgraph Retain message</div>
<div class="line">    S(Send subscription msg)</div>
<div class="line">    W(Waiting for SUBACK)</div>
<div class="line">    R(Resend subscription msg)</div>
<div class="line">    end</div>
<div class="line">    E(End)</div>
<div class="line"> </div>
<div class="line">    S --&gt; W</div>
<div class="line">    W --&gt; |Timeout| R</div>
<div class="line">    R --&gt; W</div>
<div class="line">    W --&gt; |Received SUBACK| E</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md25"></a>
Publish retry procedure</h2>
<p>The Astarte MQTT client implements a retry mechanism to ensure publish messages with QoS &gt; 0 are properly retransmitted.</p>
<h3><a class="anchor" id="autotoc_md26"></a>
QoS 1</h3>
<div class="fragment"><div class="line">%% This is a mermaid graph. Your can render it using the live editor at: https://mermaid.live</div>
<div class="line">flowchart TD</div>
<div class="line">    subgraph Retain message</div>
<div class="line">    S(Send publish msg)</div>
<div class="line">    W(Waiting for PUBACK)</div>
<div class="line">    R(Resend publish msg)</div>
<div class="line">    end</div>
<div class="line">    E(End)</div>
<div class="line"> </div>
<div class="line">    S --&gt; W</div>
<div class="line">    W --&gt; |Timeout| R</div>
<div class="line">    R --&gt; W</div>
<div class="line">    W --&gt; |Received PUBACK| E</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md27"></a>
QoS 2</h3>
<div class="fragment"><div class="line">%% This is a mermaid graph. Your can render it using the live editor at: https://mermaid.live</div>
<div class="line">flowchart TD</div>
<div class="line">    subgraph Retain message</div>
<div class="line">    SPUBLISH(Send publish msg)</div>
<div class="line">    WPUBREC(Waiting for PUBREC)</div>
<div class="line">    RPUBLISH(Resend publish msg)</div>
<div class="line">    end</div>
<div class="line">    SPUBREL(Send PUBREL msg)</div>
<div class="line">    WPUBCOMP(Waiting for PUBCOMP)</div>
<div class="line">    RPUBREL(Resend PUBREL msg)</div>
<div class="line">    E(End)</div>
<div class="line"> </div>
<div class="line">    SPUBLISH --&gt; WPUBREC</div>
<div class="line">    WPUBREC --&gt; |Timeout| RPUBLISH</div>
<div class="line">    RPUBLISH --&gt; WPUBREC</div>
<div class="line">    WPUBREC --&gt; |Received PUBREC| SPUBREL</div>
<div class="line">    SPUBREL --&gt; WPUBCOMP</div>
<div class="line">    WPUBCOMP --&gt; |Timeout| RPUBREL</div>
<div class="line">    RPUBREL --&gt; WPUBCOMP</div>
<div class="line">    WPUBCOMP --&gt; |Received PUBCOMP| E</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md28"></a>
Reception of QoS 1 publishes</h2>
<p>Upon the reception of a QoS 1 publish message the Astarte MQTT driver automatically transmit a PUBACK message back to the MQTT broker.</p>
<h2><a class="anchor" id="autotoc_md29"></a>
Reception of QoS 2 messages</h2>
<p>QoS 2 publishes require a more complex control flow in the receiver compared to lower QoS levels.</p>
<div class="fragment"><div class="line">%% This is a mermaid graph. Your can render it using the live editor at: https://mermaid.live</div>
<div class="line">flowchart TD</div>
<div class="line">    subgraph Retain message</div>
<div class="line">    START(Start)</div>
<div class="line">    SPUBREC(Send PUBREC msg)</div>
<div class="line">    end</div>
<div class="line">    WPUBREL(Waiting for PUBREL)</div>
<div class="line">    RPUBREC(Resend PUBREC msg)</div>
<div class="line">    SPUBCOMP(Send PUBCOMP msg)</div>
<div class="line">    E(End)</div>
<div class="line"> </div>
<div class="line">    START --&gt; |Received publish| SPUBREC</div>
<div class="line">    SPUBREC --&gt; WPUBREL</div>
<div class="line">    WPUBREL --&gt; |Timeout| RPUBREC</div>
<div class="line">    RPUBREC --&gt; WPUBREL</div>
<div class="line">    WPUBREL --&gt; |Received PUBREC| SPUBCOMP</div>
<div class="line">    SPUBCOMP --&gt; E</div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.12.0 </li>
  </ul>
</div>
</body>
</html>
